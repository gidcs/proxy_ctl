#!/bin/bash
# proxy_ctl used for nginx reverse proxy
# https://github.com/gidcs/proxy_ctl
# proxy_ctl

NGINX_DIR="/etc/nginx"
NGINX_CONF_DIR="${NGINX_DIR}/conf.d"
NGINX_SSL_DIR="${NGINX_DIR}/ssl"
NGINX_LOG_DIR="/var/www/logs"
ACME_SH_DIR="/root/.acme.sh"
ACME_SH="${ACME_SH_DIR}/acme.sh"
DHPARAM_PEM="${NGINX_SSL_DIR}/dhparam.pem"

if [ ! -d ${NGINX_DIR} ]; then
    echo "Please install nginx before using proxy_ctl."
    exit 1
fi
if [ ! -d ${NGINX_CONF_DIR} ]; then
    echo "The nginx configuration directory does not exist."
    exit 1
fi
if [ ! -d ${NGINX_SSL_DIR} ]; then
    mkdir ${NGINX_SSL_DIR}
fi
if [ ! -d ${NGINX_LOG_DIR} ]; then
    mkdir -p ${NGINX_LOG_DIR}
fi
if [ ! -f ${ACME_SH} ]; then
    echo "Please install acme.sh before using this tool."
    exit 1
fi
if [ ! -f ${DHPARAM_PEM} ]; then
    openssl dhparam -out ${DHPARAM_PEM} 2048 || exit 1
    chmod 400 ${DHPARAM_PEM}
fi

EXAMPLE_CONF='
server {
    listen 80;
    listen [::]:80;

    server_name SERVERNAME;
    #return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name SERVERNAME;

    access_log  /var/www/logs/SERVERNAME.access.log main;
    error_log  /var/www/logs/SERVERNAME.error.log error;

    ##ssl on;
    ##ssl_session_cache shared:SSL:10m;
    ##ssl_session_timeout  24h;
    ##ssl_buffer_size 1400;
    ##ssl_session_tickets off;

    ##ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

    ##ssl_prefer_server_ciphers on;
    ##ssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;

    # certificate and dhparam
    ##ssl_certificate /etc/nginx/ssl/SERVERNAME.chained.crt;
    ##ssl_certificate_key /etc/nginx/ssl/SERVERNAME.key;
    ##ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    # OCSP Stapling
    ##ssl_stapling on;
    ##ssl_stapling_verify on;
    ##resolver 8.8.4.4 8.8.8.8 valid=300s;
    ##resolver_timeout 10s;

    # SPDY
    ##spdy_keepalive_timeout 300;
    ##spdy_headers_comp 9;

    # Enable HSTS
    ##add_header Strict-Transport-Security max-age=63072000;

    # Do not allow this site to be displayed in iframes
    ##add_header X-Frame-Options DENY;

    # Do not permit Content-Type sniffing.
    ##add_header X-Content-Type-Options nosniff;

    location / {
    	limit_except GET POST {
    		deny all;
    	}

        proxy_pass http://ADDRESS;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}'

function help {
    case $1 in
        "add")
            echo "Usage: "
            echo "proxy_ctl add <domain> <ipaddr:port>"
            ;;
        "del")
            echo "Usage: "
            echo "proxy_ctl del <domain>"
            ;;
        *)
            echo "Usage: "
            echo "proxy_ctl list"
            echo "proxy_ctl add <domain> <ipaddr:port>"
            echo "proxy_ctl del <domain>"
            echo " "
            echo "Example: "
            echo "proxy_ctl list"
            echo "proxy_ctl add example.com server.example.com"
            echo "proxy_ctl add example.com server.example.com:8080"
            echo "proxy_ctl add example.com 10.0.2.15"
            echo "proxy_ctl del example.com"
            ;;
    esac
    exit 1
}

function valid_domain {
    domain=$1
    ret=`echo ${domain} | \
        awk '/^(([a-zA-Z0-9](-?[a-zA-Z0-9])*)\.)+[a-zA-Z]{2,63}$/'`
    if [ "${domain}" == "${ret}" ]; then
        echo 1
    else
        echo 0
    fi
}

function valid_ip {
    ipaddr=$1
    ret=`echo ${ipaddr} | \
        awk -F'.' '$0 ~ /^([0-9]{1,3}\.){3}[0-9]{1,3}$/ && \
        $1 <=255 && $2 <= 255 && $3 <= 255 && $4 <= 255 '`
    if [ "${ipaddr}" == "${ret}" ]; then
        echo 1
    else
        echo 0
    fi
}

function valid_port {
    port=$1
    ret=`echo ${port} | \
        awk '$0 ~ /^([0-9]{1,5})$/ && $0 >= 1 && $0 <= 65535'`
    if [ "${port}" == "${ret}" ]; then
        echo 1
    elif [ "${port}" == "" ]; then
        echo 1
    else
        echo 0
    fi
}

function valid_address {
    address=$1
    addr=`echo ${address} | awk -F':' '{ print $1 }'`
    port=`echo ${address} | awk -F':' '{ print $2 }'`
    if [ "`valid_ip ${addr}`" == "1" ] && \
        [ "`valid_port ${port}`" == "1" ]; then
        echo 1
    elif [ "`valid_domain ${addr}`" == "1" ] && \
        [ "`valid_port ${port}`" == "1" ]; then
        echo 1
    else
        echo 0
    fi
}

function error_ssl {
    domain=$1
    rm -f ${NGINX_CONF_DIR}/${domain}.conf
    rm -f ${NGINX_SSL_DIR}/${domain}.*
    rm -rf 
    echo "Error Found! Procedure Terminated."
    exit 1
}

function install_ssl {
    domain=$1
    ${ACME_SH} --issue -d ${domain} --nginx
    [ "$?" == "1" ] && error_ssl ${domain}
    ${ACME_SH} --install-cert -d ${domain} \
    --key-file       ${NGINX_SSL_DIR}/${domain}.key  \
    --fullchain-file ${NGINX_SSL_DIR}/${domain}.chained.crt \
    --reloadcmd     "service nginx force-reload" || error_ssl ${domain}
    chmod 400 ${NGINX_SSL_DIR}/${domain}.key
    chmod 400 ${NGINX_SSL_DIR}/${domain}.chained.crt
}

function add_domain {
    domain=$1
    address=$2
    if [ -f "${NGINX_CONF_DIR}/${domain}.conf" ]; then
        echo "The file ${NGINX_CONF_DIR}/${domain}.conf exists."
        exit 0
    else
        myip=`curl -s https://api.ipify.org`
        domain_ip=`getent hosts ${domain} | awk '{ print $1 }'`
        if [ "${myip}" != "${domain_ip}" ]; then
            echo "Please resolve your domain to ${myip}."
            exit 1
        fi

        echo "${EXAMPLE_CONF}" > ${NGINX_CONF_DIR}/${domain}.conf
        sed -i 's/SERVERNAME/'${domain}'/g' ${NGINX_CONF_DIR}/${domain}.conf
        sed -i 's/ADDRESS/'${address}'/g' ${NGINX_CONF_DIR}/${domain}.conf
        service nginx reload &>/dev/null
        install_ssl ${domain}
        sed -i 's/##//g' ${NGINX_CONF_DIR}/${domain}.conf
        service nginx reload &>/dev/null
        echo "${domain} is ready now."
    fi
}

function del_domain {
    domain=$1
    if [ -f "${NGINX_CONF_DIR}/${domain}.conf"  ]; then
        rm -f ${NGINX_CONF_DIR}/${domain}.conf
        rm -f ${NGINX_SSL_DIR}/${domain}.*
        service nginx reload &>/dev/null
        echo "${domain} is deleted."
    else
        echo "The file ${NGINX_CONF_DIR}/${domain}.conf does not exist."
    fi
}

function file_exists_wildcard {
  ls $1 > /dev/null 2>&1
  if [ "$?" == "0" ]; then
    echo 1
  else
      echo 0
  fi
}

function list {
    echo "domain   proxy_address"
    echo "------   -------------"
    if [ `file_exists_wildcard ${NGINX_CONF_DIR}/*.conf` ]; then
        grep proxy_pass ${NGINX_CONF_DIR}/*.conf | awk '{ print $1"/"$3}' | \
            awk -F'/' '{ print substr($5, 0, length($5)-6)"   "\
            substr($8,0,length($8)-1)}'
    fi
}

case $1 in
    "list")
        list
        ;;
    "add")
        if [ $# -ne 3 ] || [ "`valid_domain $2`" == "0" ] || \
            [ "`valid_address $3`" == "0" ]; then
            help "add"
        fi
        add_domain $2 $3
        ;;
    "del")
        if [ $# -ne 2 ] || [ "`valid_domain $2`" == "0" ]; then
            help "del"
        fi
        del_domain $2
        ;;
    *)
        help
        ;;
esac
